<!DOCTYPE html>
<html>

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="MarkBind 2.14.1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CS2030 AY19/20 Semester 2</title>
  <link rel="stylesheet" href="../../../../markbind/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../../../markbind/css/bootstrap-vue.min.css">
  <link rel="stylesheet" href="../../../../markbind/fontawesome/css/all.min.css">
  <link rel="stylesheet" href="../../../../markbind/glyphicons/css/bootstrap-glyphicons.min.css">
  <link rel="stylesheet" href="../../../../markbind/css/octicons.css">
  <link rel="stylesheet" href="../../../../markbind/css/github.min.css">
  <link rel="stylesheet" href="../../../../markbind/css/markbind.css">
  <link rel="stylesheet" href="/1920-s2/plugins/markbind-plugin-anchors/markbind-plugin-anchors.css">
  <link rel="stylesheet" href="../../../../markbind/layouts/default/styles.css">
  <link rel="stylesheet" href="../../../../markbind/css/page-nav.css">
</head>

<body data-spy="scroll" data-target="#page-nav" data-offset="100">
  <div id="app">
    <header>
      <navbar type="dark" class="temp-navbar">
        <a slot="brand" href="/1920-s2/index.html" title="Home" class="navbar-brand">CS2030 AY19/20 Semester 2</a>
        <div class="nav-link temp-dropdown-placeholder">Peer Learning</div>
        <dropdown class="nav-link temp-dropdown"><template slot="_header">Peer Learning</template>
          <li><a href="/1920-s2/contents/peerlearning/peerlearning.html" class="dropdown-item">Introduction</a></li>
          <li><a href="/1920-s2/contents/peerlearning/textbook.html" class="dropdown-item">Textbook Contributions</a></li>
          <li><a href="/1920-s2/contents/peerlearning/peerlearningtask.html" class="dropdown-item">Peer Learning Tasks</a></li>
          <li><a href="/1920-s2/contents/peerlearning/piazza.html" class="dropdown-item">Piazza Participation</a></li>
        </dropdown>
        <div class="nav-link temp-dropdown-placeholder">Guides</div>
        <dropdown class="nav-link temp-dropdown"><template slot="_header">Guides</template>
          <li><a href="/1920-s2/contents/guides/settingUpLabEnv.html" class="dropdown-item">Setting Up Lab Environment</a></li>
          <li><a href="/1920-s2/contents/guides/settingUpJava.html" class="dropdown-item">Setting Up Java</a></li>
          <li><a href="/1920-s2/contents/guides/settingUpVim.html" class="dropdown-item">Setting Up Vim</a></li>
          <li><a href="/1920-s2/contents/guides/settingUpMacVim.html" class="dropdown-item">Setting Up MacVim</a></li>
          <li><a href="/1920-s2/contents/guides/sunfireLabs.html" class="dropdown-item">Setting Up Sunfire and PE Nodes</a></li>
          <li><a href="/1920-s2/contents/guides/settingUpCheckstyle.html" class="dropdown-item">Setting Up Checkstyle</a></li>
        </dropdown>
        <li><a slot="brand" href="/1920-s2/contents/textbook/textbook.html" class="nav-link">Textbook</a></li>
        <div class="nav-link temp-dropdown-placeholder">Links</div>
        <dropdown class="nav-link temp-dropdown"><template slot="_header">Links</template>
          <li><a href="https://www.comp.nus.edu.sg/~cs2030/style/" class="dropdown-item" target="_blank">CS2030 Java Style Guide</a></li>
          <li><a href="https://www.comp.nus.edu.sg/~cs2030/javadoc/" class="dropdown-item" target="_blank">CS2030 Javadoc Specification</a></li>
          <li><a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk11-downloads-5066655.html" class="dropdown-item" target="_blank">JDK 11 Download Link</a></li>
          <li><a href="https://codecrunch.comp.nus.edu.sg/" class="dropdown-item" target="_blank">Codecrunch</a></li>
          <li><a href="https://github.com/nus-cs2030/1920-s2" class="dropdown-item" target="_blank">Github Repo</a></li>
          <li><a href="https://piazza.com/class/k54zo22zq1t2zc" class="dropdown-item" target="_blank">Piazza Forum</a></li>
        </dropdown>
        <li slot="right">
          <form class="navbar-form">
            <searchbar :data="searchData" placeholder="Search" :on-hit="searchCallback" menu-align-right></searchbar>
          </form>
        </li>
      </navbar>
    </header>
    <div id="flex-body">

      <div id="content-wrapper">
        <br>
        <h1 id="intro-to-asynchronous-programming-part-two">Intro to Asynchronous Programming (Part Two)<a class="fa fa-anchor" href="#intro-to-asynchronous-programming-part-two" onclick="event.stopPropagation()"></a></h1>
        <br>

        <p><a href="https://github.com/nus-cs2030/1920-s2/edit/master/contents/textbook/lecture11/asyncIntro/asyncIntro2.md">Edit the material here! <span aria-hidden="true" class="fas fa-pen"></span></a></p>

        <p>Original Credits go to <a href="https://nus-cs2030.github.io/1718-s2/lec11/index.html">Prof Ooi's AY2017/2018 Semester 2 CS2030 Website</a></p>
        <h2 id="recap">Recap<a class="fa fa-anchor" href="#recap" onclick="event.stopPropagation()"></a></h2>
        <p>We recall that we have covered the concept of <code>CompletableFuture</code> in the <a href="/1920-s2/contents/textbook/lecture11/asyncIntro/asyncIntro.html">previous segment</a></p>
        <h2 id="functors-and-monads-with-completablefuture">Functors and Monads with CompletableFuture<a class="fa fa-anchor" href="#functors-and-monads-with-completablefuture" onclick="event.stopPropagation()"></a></h2>
        <p><code>CompletableFuture</code> is a functor. Recall that a functor, in OO-speak, is a class that implements a (hypothetical) interface that looks like the following:</p>
        <pre><code class="hljs Java"><span><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Functor</span>&lt;<span class="hljs-title">T</span>&gt; </span>{<br></span><span>  <span class="hljs-keyword">public</span> &lt;R&gt; <span class="hljs-function">Functor&lt;R&gt; <span class="hljs-title">f</span><span class="hljs-params">(Function&lt;T,R&gt; func)</span></span>;<br></span><span>}<br></span></code></pre>
        <p>In <code>CompletableFuture</code>, the method that makes <code>CompletableFuture</code> a functor is the <code>thenApply</code> method:</p>
        <pre><code class="hljs Java"><span>&lt;U&gt; <span class="hljs-function">CompletableFuture&lt;U&gt; <span class="hljs-title">thenApply</span><span class="hljs-params">(Function&lt;? <span class="hljs-keyword">super</span> T, ? extends U&gt; func)</span></span><br></span></code></pre>
        <p>The method <code>thenApply</code> is similar to <code>thenAccept</code>, except that instead of a <code>Consumer</code>, the callback that gets invoked when the asynchronous task completes is a <code>Function</code>.</p>
        <p>There are other variations:</p>
        <ul>
          <li><code>thenRun</code>, which takes a <code>Runnable</code>,</li>
          <li><code>thenAcceptBoth</code>, which takes a <code>BiConsumer</code> and another <code>CompletableFuture</code></li>
          <li><code>thenCombine</code>, which takes a <code>BiFunction</code> and another <code>CompletableFuture</code></li>
          <li><code>thenCompose</code>, which takes in a <code>Function</code> <code>fn</code>, which instead of returning a &quot;plain&quot; type, <code>fn</code> returns a <code>CompletableFuture</code>.</li>
        </ul>
        <p>All the methods above return a <code>CompletableFuture</code>.</p>
        <p>By the way, <code>CompletableFuture</code> is a monad too! The <code>thenCompose</code> method is analougous to the <code>flatMap</code> method of <code>Stream</code> and <code>Optional</code>.</p>
        <p>This also means that <code>CompletableFuture</code> satisfies the monad laws, one of which is that there is a method to wrap a value around with a <code>CompletableFuture</code>.<br>
          We call this the <code>of</code> method in the context of <code>Stream</code> and <code>Optional</code>, but in <code>CompletableFuture</code>, it is called <code>completedFuture</code>. This method creates a <code>CompletableFuture</code> that is completed.</p>
        <p>The <code>completedFuture</code> method is useful, for instance, if we want to convert a method below to asynchronous.</p>
        <pre><code class="hljs Java"><span><span class="hljs-function">Integer <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x)</span> </span>{<br></span><span>  <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span>) {<br></span><span>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br></span><span>  } <span class="hljs-keyword">else</span> {<br></span><span>    <span class="hljs-keyword">return</span> doSomething(x);<br></span><span>  }<br></span><span>}<br></span></code></pre>
        <p>With <code>CompletableFuture</code>, it becomes:</p>
        <pre><code class="hljs Java"><span><span class="hljs-function">CompletableFuture&lt;Integer&gt; <span class="hljs-title">fooAsync</span><span class="hljs-params">(<span class="hljs-keyword">int</span> x)</span> </span>{<br></span><span>  <span class="hljs-keyword">if</span> (x &lt; <span class="hljs-number">0</span>) {<br></span><span>    <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-number">0</span>);<br></span><span>  } <span class="hljs-keyword">else</span> {<br></span><span>    <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; doSomething(x));<br></span><span>  }<br></span></code></pre>
        <box type="warning">
          The following is an additional example covered in AY 2017/2018 Semester 2
        </box>
        <p>In the class, I got carried away with the question about <code>completedFuture</code> and added the following example for <code>thenCompose</code> as well:</p>
        <p>Original non-async version:</p>
        <pre><code class="hljs Java"><span><span class="hljs-keyword">int</span> x = bar(z);<br></span><span><span class="hljs-keyword">int</span> y = foo(x);<br></span></code></pre>
        <p>Async version:</p>
        <pre><code class="hljs Java"><span>y = barAsync(z)<br></span><span>        .thenCompose(i -&gt; fooAsync(i))<br></span><span>        .get();<br></span></code></pre>
        <p>When we discussed about monad, we say that one way to think of a monad as a wrapper of a value in some context. In the case of <code>Optional</code>, the context is that the value may or may not be there. In the context of <code>CompletableFuture</code>, the context is that the value not be available yet.</p>
        <p>Being a functor and a monad, <code>CompletableFuture</code> objects can be chained together, just like <code>Stream</code> and <code>Optional</code>. We can write code like this:</p>
        <pre><code class="hljs Java"><span>CompletableFuture<br></span><span>    .completedFuture(Matrix.generate(nRows, nCols, rng::nextDouble))<br></span><span>    .thenApply(m -&gt; m.multiply(m1))<br></span><span>    .thenApply(m -&gt; m.add(m2))<br></span><span>    .thenApply(m -&gt; m.transpose)<br></span><span>    .thenAccept(System.out::println);<br></span></code></pre>
        <p>Another example:</p>
        <pre><code class="hljs Java"><span>CompletableFuture left = CompletableFuture<br></span><span>    .supplyAsync(() -&gt; a1.multiply(b1));<br></span><span>    <br></span><span>CompletableFuture right = CompletableFuture<br></span><span>    .supplyAsync(() -&gt; a2.multiply(b2))<br></span><span>    .thenCombine(left, (m1, m2) -&gt; m1.add(m2));<br></span><span>    .thenAccept(System.out::println);<br></span></code></pre>
        <p>Similar to <code>Stream</code>, some of the methods are terminal (e.g., <code>thenRun</code>, <code>thenAccept</code>), and some are intermediate (<code>thenApply</code>).</p>
        <h2 id="variations">Variations<a class="fa fa-anchor" href="#variations" onclick="event.stopPropagation()"></a></h2>
        <ul>
          <li>
            <p>There are variations of methods with name containing the word <code>Either</code> or <code>Both</code>, taking in another <code>CompletableFuture</code>. These methods invoke the given <code>Function</code>/<code>Runnable</code>/<code>Consumer</code> when either one (for <code>Either</code>) or both (for <code>Both</code>) of the <code>CompletableFuture</code> completes.</p>
          </li>
          <li>
            <p>There are variations of methods with name ending with the word <code>Async</code>. These methods are called asynchronously in another thread</p>
          </li>
        </ul>
        <p>For example, <code>runAfterBothAsync(future, task)</code> would run <code>task</code> only after <code>this</code> and given <code>future</code> is completed.</p>
        <p>Other features of <code>CompletableFuture</code> include:</p>
        <ul>
          <li>
            <p>Some methods take in additional <code>Executor</code> parameter, for cases where running in the default <code>ForkJoinPool</code> is not good enough.</p>
          </li>
          <li>
            <p>Some methods takes in additional <code>Throwable</code> parameter, for cases where earlier calls might throw an exception.</p>
          </li>
        </ul>
        <h2 id="handling-exceptions">Handling Exceptions<a class="fa fa-anchor" href="#handling-exceptions" onclick="event.stopPropagation()"></a></h2>
        <p>Handling exceptions is non-trivial for asynchronous methods. Remember that, in synchronous method calls, the exceptions are repeatedly thrown to the caller up the call stack, until someone catches the exception. For asynchronous calls, it is not so obvious. For instance, should we put a catch around <code>fork()</code> or around <code>join()</code>? A <code>ForkJoinTask</code> doesn't handle exception with catch, but instead requires us to check for <code>isCompletedAbnormally</code> and then call <code>getException</code> to get the exception thrown.</p>
        <p>As <code>CompletableFuture</code> allows chaining, it provides a cleaner way to pass exceptions from one call to the next. The terminal operation <code>whenComplete</code> takes in a <code>BiConsumer</code> as parameter -- the first argument to the <code>BiConsumer</code> is the result from previous chain (or <code>null</code> if exception thrown); the second argument is an exception (null if completes normally).</p>
        <pre><code class="hljs Java"><span>CompletableFuture<br></span><span>    .completedFuture(Matrix.generate(nRows, nCols, rng::nextDouble))<br></span><span>    .thenApply(m -&gt; m.multiply(m))<br></span><span>    .whenComplete((result, exception) -&gt; {<br></span><span>        <span class="hljs-keyword">if</span> (exception) { <br></span><span>            System.err.println(exception);<br></span><span>        } <span class="hljs-keyword">else</span> {<br></span><span>            System.out.print(result);<br></span><span>        }<br></span><span>    }<br></span></code></pre>
        <p><code>whenComplete</code> returns a CompletableFuture, surprisingly, despite it taking in a <code>BiConsumer</code> -- in a sense, <code>whenComplete</code> is more similar to <code>peek</code> rather than <code>forEach</code>.</p>
        <p><code>handle</code> is similar to <code>whenComplete</code>, but takes in a <code>BiFunction</code> instead of a <code>BiConsumer</code>, thus allowing the result or exception to be transformed.</p>
        <p>Finally, <code>exceptionally</code> handles exception by replacing a thrown exception with a value, similar to <code>orElse</code> in <code>Optional</code>.</p>
        <pre><code class="hljs Java"><span>CompletableFuture<br></span><span>    .completedFuture(Matrix.generate(nRows, nCols, rng::nextDouble))<br></span><span>    .thenApply(m -&gt; m.multiply(m))<br></span><span>    .exceptionally(ex -&gt; Matrix.generate(nRows, nCols, () -&gt; <span class="hljs-number">0</span>));<br></span></code></pre>
        <box type="note">
          <code>CompletableFuture</code> is similar to <code>Promise</code> in other languages, notably JavaScript and C++ <code>std::promise</code>.
        </box>
        <box type="note">
          In Java, <code>CompletableFuture</code> also implements a <code>CompletionStage</code> interface. Thus, you will find references to this interface in many places in the Java documentation. I find this name unintuitive and makes an already-confusing java documentation even harder to read.
        </box>
      </div>


      <nav id="page-nav" class="navbar navbar-light bg-transparent">
        <div class="border-left-grey nav-inner position-sticky slim-scroll">

          <nav class="nav nav-pills flex-column my-0 small no-flex-wrap">
            <a class="nav-link py-1" href="#intro-to-asynchronous-programming-part-two">Intro to Asynchronous Programming (Part Two)&#x200E;</a>
            <nav class="nav nav-pills flex-column my-0 nested no-flex-wrap">
              <a class="nav-link py-1" href="#recap">Recap&#x200E;</a>
              <a class="nav-link py-1" href="#functors-and-monads-with-completablefuture">Functors and Monads with CompletableFuture&#x200E;</a>
              <a class="nav-link py-1" href="#variations">Variations&#x200E;</a>
              <a class="nav-link py-1" href="#handling-exceptions">Handling Exceptions&#x200E;</a>
            </nav>

          </nav>
        </div>
      </nav>
    </div>
    <footer>

      <div class="text-center">
        <small>Generated by <a href="https://markbind.org/">MarkBind 2.14.1</a> on Sun, May 10, 2020, 2:29:49 PM UTC</small></div>
    </footer>
  </div>
</body>
<script src="../../../../markbind/js/vue.min.js"></script>
<script src="../../../../markbind/js/vue-strap.min.js"></script>
<script src="../../../../markbind/js/bootstrap-utility.min.js"></script>
<script src="../../../../markbind/js/polyfill.min.js"></script>
<script src="../../../../markbind/js/bootstrap-vue.min.js"></script>
<script>
  const baseUrl = '/1920-s2'
  const enableSearch = true
</script>
<script src="../../../../markbind/js/setup.js"></script>
<script src="../../../../markbind/layouts/default/scripts.js"></script>

</html>